<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  {% seo %}
  {% feed_meta %}
  <link rel="stylesheet" href="{{ site.baseurl }}/css/main.css">
  <link rel="apple-touch-icon" href="{{ site.baseurl }}/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="{{ site.baseurl }}/touch-icon.png" sizes="192x192">
  <link rel="icon" type="image/png" href="{{ site.baseurl }}/images/favicon.png">
  <script src="https://code.jquery.com/jquery-latest.min.js"></script>

  {% if jekyll.environment == 'production' and site.google_analytics_key != '' %}
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', '{{ site.google_analytics_key }}', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  {% endif %}
</head>    

<body>
<header class="post-title">
  <h1> 
    <a href="{{ site.baseurl }}/"><img src="{{ site.baseurl }}/images/favicon.png" alt="{{ site.title }} logo"></a>
    <span>{{ site.title }}</span>
    <button type="button" class="open-nav" id="open-nav"></button>
  </h1>

  <form action="{{ site.baseurl }}/search/" method="get">
    <div class="search-wrap">
      <input type="text" name="q" id="search-input" placeholder="Search" autofocus>
      <button type="button" class="btn-del"><span>삭제</span></button>
    </div>
    <input type="submit" value="Search" style="display: none;">
  </form>

  <nav {% if site.show_full_navigation %}class="full-navigation"{% endif %}>
    <div class="switch__wrap">
      <label class="switch" for="switch-1">
        <input type="checkbox" id="switch-1" data-input="switch__theme">
        <span class="switch__toggle" aria-hidden="true"></span>
      </label>
    </div>

    <ul>
      <li class="nav-item top-level {% if page.url == '/' %}current{% endif %}">
        {% assign home = site.html_pages | where: 'url', '/' | first %}
        <a href="{{ site.baseurl }}/">{{ home.title }}</a>
      </li>

      {% assign grouped = site.docs | group_by: 'category' %}
      {% for group in grouped %}
        <li class="nav-item top-level {% if group.name == page.category %}current{% endif %}">
          {% assign items = group.items | sort: 'order' %}
          <a href="{{ site.baseurl }}{{ items.first.url }}">{{ group.name }}</a>
          <ul>
            {% for item in items %}
              <li class="nav-item {% if item.url == page.url %}current{% endif %}"><a href="{{ site.baseurl }}{{ item.url }}">{{ item.title }}</a></li>
            {% endfor %}
          </ul>
        </li>
      {% endfor %}

      <li class="nav-item top-level {% if page.url == '/changelog/' %}current{% endif %}">
        {% assign changelog = site.html_pages | where: 'url', '/changelog/' | first %}
        <a href="{{ site.baseurl }}/changelog/">{{ changelog.title }}</a>
      </li>
    </ul>
  </nav>
</header>
</body>

<section class="main post-article">
  <div class="page-header">
    <h2>{% if page.category %}{{ page.category }}{% else %}{{ site.title }}{% endif %}</h2>
    <h3>{{ page.title }}</h3>
  </div>

  <article class="content">
    {{ content }}
  </article>
</section>

<div class="toc">
  <!-- <h6 class="toc-heading">Table of Contents</h6> -->
  {% include toc.html html=content %}
  <div class="top-button">
    <a href="#" id="btn-top" class="btn-top">TOP</a>
  </div>
</div>

<script>
	 document.getElementById("open-nav").addEventListener("click", function () {
  document.body.classList.toggle("nav-open");
});

function getTOCNodes(master) {
  var nodes = Array.from(master.getElementsByTagName("*"));
  var tocNodes = nodes.filter(function (elem) {
    return elem.tagName === "A";
  });
  return tocNodes;
}

function getHeaderNodes(master) {
  var nodes = Array.from(master.getElementsByTagName("*"));
  var headerNodes = nodes.filter(function (elem) {
    return (
      elem.tagName === "H1" ||
      elem.tagName === "H2" ||
      elem.tagName === "H3" ||
      elem.tagName === "H4" ||
      elem.tagName === "H5" ||
      elem.tagName === "H6"
    );
  });
  return headerNodes;
}

function smoothScrollTo(element) {
  window.scrollTo({
    behavior: "smooth",
    top: element.offsetTop
  });
}

var title = document.getElementsByClassName("post-title")[0];
var titleY = window.pageYOffset + title.getBoundingClientRect().top;

var article = document.getElementsByClassName("post-article")[0];
var articleY = window.pageYOffset + article.getBoundingClientRect().top;

var toc = document.getElementsByClassName("toc")[0];
var tocNodes = getTOCNodes(toc);
var headerNodes = getHeaderNodes(article);
var before = undefined;

function updateActiveTOCNode() {
  var current = headerNodes.find(function (header) {
    var headerY = window.pageYOffset + header.getBoundingClientRect().top;
    return window.scrollY >= headerY - 60;
  });

  tocNodes.forEach(function (tocNode) {
    tocNode.classList.remove("toc-active");
  });

  if (current) {
    var currentA = tocNodes.find(function (tocNode) {
      return tocNode.getAttribute("href") === "#" + current.id;
    });

    if (currentA) {
      currentA.classList.add("toc-active");
    }
  }
}

tocNodes.forEach(function (tocNode) {
  tocNode.addEventListener("click", function (event) {
    event.preventDefault();
    var targetId = tocNode.getAttribute("href").substr(1);
    var targetElement = document.getElementById(targetId);
    if (targetElement) {
      smoothScrollTo(targetElement);
    }
  });
});

window.addEventListener("scroll", function () {
  var tocY = window.pageYOffset + toc.getBoundingClientRect().top;
  var footer = document.getElementsByTagName("footer")[0];
  var footerY = window.pageYOffset + footer.getBoundingClientRect().top;

  if (tocY < titleY || articleY > footerY) {
    toc.classList.remove("sticky");
  } else {
    toc.classList.add("sticky");
  }

  updateActiveTOCNode();
});

// 추가된 부분: 목차 항목에 이벤트 리스너 추가
tocNodes.forEach(function (tocNode) {
  tocNode.addEventListener("click", function (event) {
    event.preventDefault();
    var targetId = tocNode.getAttribute("href").substr(1);
    var targetElement = document.getElementById(targetId);
    if (targetElement) {
      smoothScrollTo(targetElement);
    }
  });
});


  //search value delete
  const inputEl = document.querySelector("#search-input");
  const buttonEl = document.querySelector(".btn-del");
  buttonEl.classList.add("hide");
  inputEl.addEventListener("input", function () {
    if (inputEl.value !== "") {
      buttonEl.classList.remove("hide");
    } else {
      buttonEl.classList.add("hide");
    }
  });
  buttonEl.addEventListener("click", function () {
    inputEl.value = "";
    buttonEl.classList.add("hide");
  });

  //switch theme
  const rootElement = document.documentElement;
  const themeSwitchCheckbox = document.querySelector('[data-input="switch__theme"]');
  const localStorageKey = "theme";

  function setThemePreference(theme) {
    if (theme === "dark") {
      rootElement.setAttribute("data-theme", "dark");
      themeSwitchCheckbox.checked = true;
    } else {
      rootElement.setAttribute("data-theme", "light");
      themeSwitchCheckbox.checked = false;
    }
  }

  function toggleTheme() {
    if (themeSwitchCheckbox.checked) {
      localStorage.setItem(localStorageKey, "dark");
      rootElement.setAttribute("data-theme", "dark");
    } else {
      localStorage.setItem(localStorageKey, "light");
      rootElement.setAttribute("data-theme", "light");
    }
  }

  themeSwitchCheckbox.addEventListener("change", toggleTheme);

  const storedTheme = localStorage.getItem(localStorageKey);
  if (storedTheme) {
    setThemePreference(storedTheme);
  } else {
    const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches;
    setThemePreference(isDarkMode ? "dark" : "light");
  }

  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", (e) => {
    if (!localStorage.getItem(localStorageKey)) {
      setThemePreference(e.matches ? "dark" : "light");
    }
  });

  document.addEventListener("DOMContentLoaded", function () {
    var btnTop = document.getElementById("btn-top");
    btnTop.addEventListener("click", function (event) {
      event.preventDefault();
      scrollToTop();
    });

    function scrollToTop() {
      var currentScroll = document.documentElement.scrollTop || document.body.scrollTop;
      if (currentScroll > 0) {
        window.scroll({
          top: 0,
          left: 0,
          behavior: "smooth"
        });
      }
    }
  });
</script>
</html>
